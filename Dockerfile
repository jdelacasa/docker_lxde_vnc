FROM ubuntu:20.04

WORKDIR /app
COPY . .

RUN apt-get update  &&  DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tzdata keyboard-configuration

RUN apt-get install -y adduser adwaita-icon-theme alsa-utils apache2-utils apt arc-theme base-files base-passwd bash bsdutils bubblewrap bzip2 ca-certificates coreutils cpp cpp-9 curl dash dbus dbus-user-session dbus-x11 dconf-gsettings-backend dconf-service debconf debianutils dictionaries-common diffutils dirmngr distro-info-data dpkg dpkg-dev e2fsprogs emacsen-common fdisk ffmpeg findutils firefox fontconfig fontconfig-config fonts-dejavu-core fonts-liberation fonts-ubuntu fonts-wqy-zenhei galculator gcc-10-base gcc-9-base gir1.2-glib-2.0 gir1.2-packagekitglib-1.0 glib-networking glib-networking-common glib-networking-services gnome-themes-extra gnome-themes-extra-data gnome-themes-standard gnupg gnupg-l10n gnupg-utils gpg gpg-agent gpg-wks-client gpg-wks-server gpgconf gpgsm gpgv gpicview grep gsettings-desktop-schemas gtk-update-icon-cache gtk2-engines-murrine gtk2-engines-pixbuf gzip hicolor-icon-theme hostname humanity-icon-theme hunspell-en-us init-system-helpers iproute2 iso-codes kmod laptop-detect libacl1 libaom0 libapparmor1 libappstream4 libapr1 libaprutil1 libapt-pkg6.0 libargon2-1 libasn1-8-heimdal libasound2 libasound2-data libaspell15 libass9 libassuan0 libasyncns0 libatk-bridge2.0-0 libatk1.0-0 libatk1.0-data libatopology2 libatspi2.0-0 libattr1 libaudit-common libaudit1 libauthen-sasl-perl libavahi-client3 libavahi-common-data libavahi-common3 libavc1394-0 libavcodec58 libavdevice58 libavfilter7 libavformat58 libavresample4 libavutil56 libblkid1 libbluray2 libbrotli1 libbs2b0 libbsd0 libbz2-1.0 libc-bin libc6 libcaca0 libcairo-gobject2 libcairo2 libcap-ng0 libcap2 libcap2-bin libcdio-cdda2 libcdio-paranoia2 libcdio18 libchromaprint1 libcodec2-0.9 libcolord2 libcom-err2 libcrypt1 libcryptsetup12 libcups2 libcurl3-gnutls libcurl4 libdata-dump-perl libdatrie1 libdb5.3 libdbus-1-3 libdbus-glib-1-2 libdc1394-22 libdconf1 libdebconfclient0 libdevmapper1.02.1 libdrm-amdgpu1 libdrm-common libdrm-nouveau2 libdrm-radeon1 libdrm2 libedit2 libegl-mesa0 libegl1 libelf1 libenchant-2-2 libencode-locale-perl libepoxy0 libexif12 libexpat1 libext2fs2 libfakeroot libfdisk1 libffi7 libfftw3-double3 libfftw3-single3 libfile-basedir-perl libfile-desktopentry-perl libfile-listing-perl libfile-mimeinfo-perl libflac8 libflite1 libfm-data libfm-extra4 libfm-gtk-data libfm-gtk4 libfm-modules libfm4 libfont-afm-perl libfontconfig1 libfontenc1 libfreetype6 libfribidi0 libgbm1 libgcc-s1 libgcrypt20 libgd3 libgdbm-compat4 libgdbm6 libgdk-pixbuf2.0-0 libgdk-pixbuf2.0-common libgif7 libgirepository-1.0-1 libgl1 libgl1-mesa-dri libglapi-mesa libglib2.0-0 libglib2.0-bin libglib2.0-data libglvnd0 libglx-mesa0 libglx0 libgme0 libgmp10 libgnutls30 libgomp1 libgpg-error0 libgraphite2-3 libgsm1 libgssapi-krb5-2 libgssapi3-heimdal libgstreamer-gl1.0-0 libgstreamer-plugins-base1.0-0 libgstreamer1.0-0 libgtk-3-0 libgtk-3-common libgtk2.0-0 libgtk2.0-common libgtksourceview-3.0-1 libgtksourceview-3.0-common libgudev-1.0-0 libharfbuzz-icu0 libharfbuzz0b libhcrypto4-heimdal libheimbase1-heimdal libheimntlm0-heimdal libhogweed5 libhtml-form-perl libhtml-format-perl libhtml-parser-perl libhtml-tagset-perl libhtml-tree-perl libhttp-cookies-perl libhttp-daemon-perl libhttp-date-perl libhttp-message-perl libhttp-negotiate-perl libhunspell-1.7-0 libhx509-5-heimdal libhyphen0 libice6 libicu66 libid3tag0 libidn2-0 libiec61883-0 libimlib2 libio-html-perl libio-socket-ssl-perl libio-stringy-perl libip4tc2 libipc-system-simple-perl libisl22 libiw30 libjack-jackd2-0 libjavascriptcoregtk-4.0-18 libjbig0 libjpeg-turbo8 libjpeg8 libjson-c4 libjson-glib-1.0-0 libjson-glib-1.0-common libk5crypto3 libkeybinder0 libkeyutils1 libkmod2 libkrb5-26-heimdal libkrb5-3 libkrb5support0 libksba8 liblcms2-2 libldap-2.4-2 libldap-common liblilv-0-0 libllvm11 liblmdb0 liblwp-mediatypes-perl liblwp-protocol-https-perl liblz4-1 liblzma5 liblzo2-2 libmailtools-perl libmenu-cache-bin libmenu-cache3 libmnl0 libmount1 libmp3lame0 libmpc3 libmpdec2 libmpfr6 libmpg123-0 libmysofa1 libncurses6 libncursesw6 libnet-dbus-perl libnet-http-perl libnet-smtp-ssl-perl libnet-ssleay-perl libnettle7 libnghttp2-14 libnginx-mod-http-image-filter libnginx-mod-http-xslt-filter libnginx-mod-mail libnginx-mod-stream libnorm1 libnotify4 libnpth0 libnspr4 libnss3 libnuma1 libobrender32v5 libobt2v5 libogg0 libopenal-data libopenal1 libopenjp2-7 libopenmpt0 libopus0 liborc-0.4-0 libp11-kit0 libpackagekit-glib2-18 libpam-modules libpam-modules-bin libpam-runtime libpam-systemd libpam0g libpango-1.0-0 libpangocairo-1.0-0 libpangoft2-1.0-0 libpangoxft-1.0-0 libpciaccess0 libpcre2-8-0 libpcre3 libperl5.30 libpgm-5.2-0 libpixman-1-0 libpng16-16 libpolkit-agent-1-0 libpolkit-gobject-1-0 libpostproc55 libprocps8 libproxy1v5 libpsl5 libpulse0 libpython3-stdlib libpython3.8-minimal libpython3.8-stdlib libquadmath0 libraw1394-11 libreadline8 librest-0.7-0 libroken18-heimdal librsvg2-2 librsvg2-common librtmp1 librubberband2 libsamplerate0 libsasl2-2 libsasl2-modules-db libsdl2-2.0-0 libseccomp2 libsecret-1-0 libsecret-common libselinux1 libsemanage-common libsemanage1 libsensors-config libsensors5 libsepol1 libserd-0-0 libshine3 libslang2 libsm6 libsmartcols1 libsnappy1v5 libsndfile1 libsndio7.0 libsodium23 libsord-0-0 libsoup-gnome2.4-1 libsoup2.4-1 libsoxr0 libspeex1 libsqlite3-0 libsratom-0-0 libss2 libssh-4 libssh-gcrypt-4 libssl1.1 libstartup-notification0 libstdc++6 libstemmer0d libswresample3 libswscale5 libsystemd0 libtasn1-6 libtcl8.6 libtext-iconv-perl libthai-data libthai0 libtheora0 libtie-ixhash-perl libtiff5 libtimedate-perl libtinfo6 libtk8.6 libtry-tiny-perl libtwolame0 libudev1 libunique-1.0-0 libunistring2 libunwind8 liburi-perl libusb-1.0-0 libuuid1 libva-drm2 libva-x11-2 libva2 libvdpau1 libvidstab1.1 libvncclient1 libvncserver1 libvorbis0a libvorbisenc2 libvorbisfile3 libvpx6 libvte-2.91-0 libvte-2.91-common libvulkan1 libwavpack1 libwayland-client0 libwayland-cursor0 libwayland-egl1 libwayland-server0 libwebkit2gtk-4.0-37 libwebp6 libwebpdemux2 libwebpmux3 libwind0-heimdal libwnck-common libwnck22 libwoff1 libwrap0 libwww-perl libwww-robotrules-perl libx11-6 libx11-data libx11-protocol-perl libx11-xcb1 libx264-155 libx265-179 libxau6 libxaw7 libxcb-dri2-0 libxcb-dri3-0 libxcb-glx0 libxcb-present0 libxcb-render0 libxcb-shape0 libxcb-shm0 libxcb-sync1 libxcb-util1 libxcb-xfixes0 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxdmcp6 libxext6 libxfce4util-common libxfce4util7 libxfconf-0-3 libxfixes3 libxfont2 libxft2 libxi6 libxinerama1 libxkbcommon0 libxkbfile1 libxml-parser-perl libxml-twig-perl libxml-xpathengine-perl libxml2 libxmu6 libxmuu1 libxpm4 libxrandr2 libxrender1 libxres1 libxshmfence1 libxslt1.1 libxss1 libxt6 libxtables12 libxtst6 libxv1 libxvidcore4 libxxf86dga1 libxxf86vm1 libyaml-0-2 libzmq5 libzstd1 libzvbi-common libzvbi0 login logsave lsb-base lsb-release lxappearance lxappearance-obconf lxde lxde-common lxde-core lxde-icon-theme lxhotkey-core lxhotkey-gtk lxinput lxmenu-data lxpanel lxpanel-data lxpolkit lxrandr lxsession lxsession-data lxsession-edit lxsession-logout lxterminal mawk mesa-utils mime-support mount mousepad ncurses-base ncurses-bin net-tools netbase nginx nginx-common nginx-core ocl-icd-libopencl1 openbox openbox-lxde-session openssl packagekit passwd pcmanfm perl perl-base perl-modules-5.30 perl-openssl-defaults pinentry-curses policykit-1 procps python-apt-common python3 python3-apt python3-certifi python3-chardet python3-dbus python3-gi python3-idna python3-minimal python3-pkg-resources python3-requests python3-requests-unixsocket python3-six python3-software-properties python3-urllib3 python3.8 python3.8-minimal readline-common sed sensible-utils shared-mime-info software-properties-common sudo supervisor systemd systemd-sysv systemd-timesyncd sysvinit-utils tar tcl tcl8.6 tk tk8.6 ttf-ubuntu-font-family tzdata ubuntu-keyring ubuntu-mono ucf util-linux vim-common vim-tiny wget x11-common x11-utils x11-xkb-utils x11-xserver-utils x11vnc xarchiver xauth xdg-dbus-proxy xdg-utils xfconf xkb-data xserver-common xvfb xxd xz-utils zenity zenity-common zlib1g python3-pip python3-gevent python3-gevent-websocket python-is-python3
RUN python3 -m pip install flask
RUN useradd otlab
RUN mkdir /home/otlab 
#&& cp /etc/skel/* /home/otlab/
COPY supervisord.conf /etc/supervisor/conf.d/
COPY web.tar.gz /usr/local/lib/
COPY xvfb.sh /usr/local/bin/
COPY default_nginx /etc/nginx/sites-enabled/
RUN mv /etc/nginx/sites-enabled/default_nginx /etc/nginx/sites-enabled/default
RUN cd /usr/local/lib && tar zxvf web.tar.gz
RUN mv /usr/local/lib/usr/local/lib/web /usr/local/lib/
RUN chmod +x /app/startup.sh
RUN chmod +x /usr/local/bin/xvfb.sh
ENTRYPOINT ["/app/startup.sh"]
